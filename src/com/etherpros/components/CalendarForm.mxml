<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx"  
		 xmlns:components="com.etherpros.components.*"
		 xmlns:model="com.etherpros.model.*" creationComplete="init()"
		 borderAlpha="0" xmlns:ns="http://mate.asfusion.com/">
	
	<s:layout>
		<s:HorizontalLayout horizontalAlign="center" gap="0" />
	</s:layout>
	
	<fx:Script>
		<![CDATA[
			import com.etherpros.business.ContractorDAO;
			import com.etherpros.controllers.CalendarController;
			import com.etherpros.events.*;
			import com.etherpros.model.*;
			
			import mx.collections.ArrayCollection;
			import mx.events.CalendarLayoutChangeEvent;
			
			import skins.DriversList;
			
			import spark.components.Label;
			
			[Bindable]
			public static var COLUMN_WIDTH:int = 110;
			
			[Bindable]
			private var weekArray:ArrayCollection;
			
			[Bindable]
			private var jobsController:CalendarController;
			
			[Bindable]
			private var staffDP: ArrayCollection;
			
			public var currentMonthSelected:int = -1;
			public var currentYearSelected:int = -1;
			
			[Bindable]
			private var _contractorList:ArrayCollection;

			[Bindable]
			private var _clients:ArrayCollection;
			
			private var _rigs:ArrayCollection;
			
			private var _projects:ArrayCollection;
			
			private function init():void {
				// set up controlller for rig views.
				jobsController = new CalendarController(this);
				// set the offset based on the position of the first day.
				jobsController.setOffset(grdCalendar.x + 2, grdCalendar.y + grdCalendar.columnHeaderGroup.height);
				CalendarController.setCalendarDimensions(grdCalendar.width, grdCalendar.height - grdCalendar.columnHeaderGroup.height);
			
				// create first initial month grid.
				createDaysGrid();
				//this.addEventListener(ContractorEvent.FIND_ALL_DONE, initContractorList);
				
				// Load information from Database.
				var contractorEvent:ContractorEvent = new ContractorEvent(ContractorEvent.FIND_ALL);
				mateDispatcher.dispatchEvent(contractorEvent);				
				var projectEvent:ProjectEvent = new ProjectEvent(ProjectEvent.FIND_ALL);
				mateDispatcher.dispatchEvent(projectEvent);
				var rigsEvent:RigEvent = new RigEvent(RigEvent.FIND_ALL);
				mateDispatcher.dispatchEvent(rigsEvent);
				var clientEvent:ClientEvent = new ClientEvent(ClientEvent.FIND_ALL);
				mateDispatcher.dispatchEvent(clientEvent);
			}
			
			// create grid of days in current month as per current date provided
			private function createDaysGrid():void {				
				// Dispatch monthChanged event which tell item renderers
				// to clear their values.
				dispatchEvent(new Event('monthChanged', true));
				
				// clear out old weeks
				weekArray = new ArrayCollection();
								
				var currentYear:int  = dtPicker.displayedYear;
				var currentMonth:int = dtPicker.displayedMonth;
				var range:DayRange = DayRange.createFromMonth(currentMonth, currentYear);
				
				this.currentMonthSelected = currentMonth;
				this.currentYearSelected = currentYear;
				weekArray = range.weeks;
				jobsController.dayRange = range;
			}	
			
			protected function dtPicker_changeHandler(event:CalendarLayoutChangeEvent):void {
				if ( currentMonthSelected != dtPicker.displayedMonth ){
					createDaysGrid();
				}else if ( currentYearSelected != dtPicker.displayedYear ){
					createDaysGrid();
				}
	
			}
			
			protected function dtPicker_clickHandler(event:MouseEvent):void {
				if ( currentMonthSelected != dtPicker.displayedMonth ){
					createDaysGrid();
				}else if ( currentYearSelected != dtPicker.displayedYear ){
					createDaysGrid();
				}
				
			}
			
			protected function saveJobs(event:MouseEvent):void {
				for each(var job:Job in this.jobsController.jobs){
					var jobAssignmentEvent:JobAssignmentEvent = new JobAssignmentEvent( JobAssignmentEvent.JOB_ASSIGNMENT_SAVE );
					jobAssignmentEvent.job = job;
					mateDispatcher.dispatchEvent(jobAssignmentEvent);
				}
				
			}	
			
			[Bindable]
			public function set contractorList(value:ArrayCollection):void {
				_contractorList = value;
			}
			
			public function get contractorList():ArrayCollection { 
				return _contractorList;
			}
			
			[Bindable]
			public function get clients():ArrayCollection { 
				return _clients; 
			}
			
			public function set clients(value:ArrayCollection):void {
				trace("Client's successfully loaded!");
				_clients = value;
			}

			[Bindable]
			public function get rigs():ArrayCollection
			{
				return _rigs;
			}

			public function set rigs(value:ArrayCollection):void
			{
				_rigs = value;
			}

			[Bindable]
			public function get projects():ArrayCollection
			{
				return _projects;
			}

			public function set projects(value:ArrayCollection):void
			{
				_projects = value;
			}


		]]>
	</fx:Script>
	<fx:Declarations>
		<ns:Dispatcher id="mateDispatcher" />
	</fx:Declarations>
	
	<s:VGroup width="245" height="766" horizontalAlign="center" paddingLeft="10" paddingRight="10" paddingTop="10" gap="15" >
		<components:TitleBox label="Clients" />

	</s:VGroup>
	
	<s:Group id="gridContainer">

		<s:DataGrid id="grdCalendar" width="774" height="766" dataProvider="{weekArray}"
					requestedRowCount="4" rowHeight="123" selectionMode="none">			
			<s:columns>
				<s:ArrayList>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="sunday" headerText="Sunday" resizable="false"
								  sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="monday" headerText="Monday" resizable="false"
								  sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="tuesday" headerText="Tuesday"
								  resizable="false" sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="wednesday" headerText="Wednesday"
								  resizable="false" sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="thursday" headerText="Thursday"
								  resizable="false" sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="friday" headerText="Friday" resizable="false"
								  sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
					<s:GridColumn width="{COLUMN_WIDTH}" dataField="saturday" headerText="Saturday"
								  resizable="false" sortable="false" itemRenderer="com.etherpros.components.DayView">
					</s:GridColumn>
				</s:ArrayList>
			</s:columns>			
		</s:DataGrid>
	
	</s:Group>

	<s:VGroup width="245" height="766" horizontalAlign="center" paddingLeft="10" paddingRight="10" paddingTop="10" gap="15" >
		<components:TitleBox label="Date Picker" />
		
		<mx:DateChooser id="dtPicker" height="31" enabled="true" showToday="false"
						change="dtPicker_changeHandler(event)" click="dtPicker_clickHandler(event)" 
						yearNavigationEnabled="true"/>
		<s:Button id="btnSaveJobs" label="Save Jobs" click="saveJobs(event)"/>
		
		<s:Spacer height="30" />
		
		<components:TitleBox label="Drivers" />
		<s:List id="staffList" width="100%" height="100%" dragEnabled="true" 
				dropEnabled="false" skinClass="skins.DriversList" dataProvider="{ contractorList }">
			<s:itemRenderer>
				<fx:Component>
					<s:ItemRenderer height="28">
						<fx:Script>
							<![CDATA[
								import com.etherpros.model.Contractor;
							]]>
						</fx:Script>
						<s:Label fontFamily="Frutiger" color="#555555" fontSize="17" text="{Contractor(data).FullName}" verticalCenter="0" horizontalCenter="0" />	
					</s:ItemRenderer>					
				</fx:Component>
			</s:itemRenderer>
		</s:List>
	</s:VGroup>
		
</s:BorderContainer>
